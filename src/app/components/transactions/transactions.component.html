<div class="layout">
  <app-sidebar
    [userName]="authService.currentUser()?.name || ''"
    [isAdmin]="authService.isAdmin()"
  />

  <div class="transactions-container">
    <header class="header">
      <div class="header-content">
        <h1>Transaction History</h1>
        <div class="header-actions">
          <span class="user-info">{{ authService.currentUser()?.name }}</span>
          <button class="btn-secondary" (click)="navigateToWelcome()">Back to Dashboard</button>
          <button class="btn-logout" (click)="authService.logout()">Logout</button>
        </div>
      </div>
    </header>

    <main class="main-content">
      @if (error()) {
        <div class="alert alert-error">{{ error() }}</div>
      }

      @if (success()) {
        <div class="alert alert-success">{{ success() }}</div>
      }

      <div class="stats-grid">
        <div class="stat-card sales">
          <div class="stat-icon">üí∞</div>
          <div class="stat-content">
            <div class="stat-label">Total Sales</div>
            <div class="stat-value">${{ getTotalSales().toFixed(2) }}</div>
          </div>
        </div>
        <div class="stat-card purchases">
          <div class="stat-icon">üõí</div>
          <div class="stat-content">
            <div class="stat-label">Total Purchases</div>
            <div class="stat-value">${{ getTotalPurchases().toFixed(2) }}</div>
          </div>
        </div>
        <div class="stat-card transactions">
          <div class="stat-icon">üìä</div>
          <div class="stat-content">
            <div class="stat-label">Total Transactions</div>
            <div class="stat-value">{{ filteredTransactions().length }}</div>
          </div>
        </div>
      </div>

      <div class="toolbar">
        <div class="filters">
          <div class="search-box">
            <input
              type="text"
              placeholder="Search transactions..."
              [ngModel]="searchTerm()"
              (ngModelChange)="searchTerm.set($event); applyFilters()"
              class="search-input"
            />
            <span class="search-icon">üîç</span>
          </div>
          <select
            [ngModel]="filterType()"
            (ngModelChange)="filterType.set($event); applyFilters()"
            class="filter-select"
          >
            <option value="all">All Types</option>
            <option value="purchase">Purchases</option>
            <option value="sale">Sales</option>
          </select>
          <input
            type="date"
            [ngModel]="startDate()"
            (ngModelChange)="startDate.set($event); applyFilters()"
            class="date-input"
            placeholder="Start Date"
          />
          <input
            type="date"
            [ngModel]="endDate()"
            (ngModelChange)="endDate.set($event); applyFilters()"
            class="date-input"
            placeholder="End Date"
          />
        </div>
        @if (authService.isAdmin()) {
          <button class="btn-create" (click)="openCreateModal()">
            + New Transaction
          </button>
        }
      </div>

      <div class="transactions-table-container">
        <table class="transactions-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Product</th>
              <th>SKU</th>
              <th>Type</th>
              <th>Quantity</th>
              <th>Unit Price</th>
              <th>Total Amount</th>
              <th>User</th>
              @if (authService.isAdmin()) {
                <th>Actions</th>
              }
            </tr>
          </thead>
          <tbody>
            @if (filteredTransactions().length === 0) {
              <tr>
                <td [attr.colspan]="authService.isAdmin() ? 9 : 8" class="no-data">
                  <div class="no-data-content">
                    <span class="no-data-icon">üìã</span>
                    <p>No transactions found</p>
                  </div>
                </td>
              </tr>
            } @else {
              @for (transaction of paginatedTransactions(); track transaction.id) {
                <tr>
                  <td>{{ formatDate(transaction.date) }}</td>
                  <td class="product-name">{{ transaction.productName }}</td>
                  <td class="sku">{{ transaction.productSku }}</td>
                  <td>
                    <span class="type-badge" [class.purchase]="transaction.type === 'purchase'" [class.sale]="transaction.type === 'sale'">
                      {{ transaction.type === 'purchase' ? 'Purchase' : 'Sale' }}
                    </span>
                  </td>
                  <td>{{ transaction.quantity }}</td>
                  <td>${{ transaction.unitPrice.toFixed(2) }}</td>
                  <td class="amount">${{ transaction.totalAmount.toFixed(2) }}</td>
                  <td>{{ transaction.userName }}</td>
                  @if (authService.isAdmin()) {
                    <td>
                      <button class="btn-delete" (click)="deleteTransaction(transaction.id)">Delete</button>
                    </td>
                  }
                </tr>
              }
            }
          </tbody>
        </table>
      </div>

      @if (filteredTransactions().length > 0 && totalPages() > 1) {
        <div class="pagination-container">
          <div class="pagination-info">
            Showing {{ ((currentPage() - 1) * pageSize) + 1 }} - {{ Math.min(currentPage() * pageSize, filteredTransactions().length) }} of {{ filteredTransactions().length }} transactions
          </div>
          <div class="pagination-controls">
            <button 
              class="pagination-btn" 
              [disabled]="currentPage() === 1"
              (click)="previousPage()"
              [class.disabled]="currentPage() === 1"
            >
              ‚Üê Previous
            </button>
            
            <div class="page-numbers">
              @if (totalPages() <= 7) {
                @for (page of getPageNumbers(); track page) {
                  <button
                    class="page-number"
                    [class.active]="currentPage() === page"
                    (click)="goToPage(page)"
                  >
                    {{ page }}
                  </button>
                }
              } @else {
                @if (currentPage() <= 3) {
                  @for (page of getPageNumbers(); track page) {
                    <button
                      class="page-number"
                      [class.active]="currentPage() === page"
                      (click)="goToPage(page)"
                    >
                      {{ page }}
                    </button>
                  }
                  <span class="page-ellipsis">...</span>
                  <button
                    class="page-number"
                    (click)="goToPage(totalPages())"
                  >
                    {{ totalPages() }}
                  </button>
                } @else if (currentPage() >= totalPages() - 2) {
                  <button
                    class="page-number"
                    (click)="goToPage(1)"
                  >
                    1
                  </button>
                  <span class="page-ellipsis">...</span>
                  @for (page of getPageNumbers(); track page) {
                    <button
                      class="page-number"
                      [class.active]="currentPage() === page"
                      (click)="goToPage(page)"
                    >
                      {{ page }}
                    </button>
                  }
                } @else {
                  <button
                    class="page-number"
                    (click)="goToPage(1)"
                  >
                    1
                  </button>
                  <span class="page-ellipsis">...</span>
                  @for (page of getPageNumbers(); track page) {
                    <button
                      class="page-number"
                      [class.active]="currentPage() === page"
                      (click)="goToPage(page)"
                    >
                      {{ page }}
                    </button>
                  }
                  <span class="page-ellipsis">...</span>
                  <button
                    class="page-number"
                    (click)="goToPage(totalPages())"
                  >
                    {{ totalPages() }}
                  </button>
                }
              }
            </div>
            
            <button 
              class="pagination-btn"
              [disabled]="currentPage() === totalPages()"
              (click)="nextPage()"
              [class.disabled]="currentPage() === totalPages()"
            >
              Next ‚Üí
            </button>
          </div>
        </div>
      }
    </main>
  </div>
</div>

@if (showCreateModal() && authService.isAdmin()) {
  <div class="modal-overlay" (click)="closeCreateModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Create New Transaction</h3>
        <button class="modal-close" (click)="closeCreateModal()">√ó</button>
      </div>
      <div class="modal-body">
        @if (productService.isLoading()) {
          <div style="text-align: center; padding: 20px; color: #718096;">
            Loading products...
          </div>
        } @else if (availableProducts.length === 0) {
          <div style="text-align: center; padding: 20px; color: #fc8181;">
            No products available. Please create a product first.
          </div>
        } @else {
          <div class="form-group">
            <label>Product *</label>
            <select [(ngModel)]="createForm.productId" required>
              <option value="">Select a product</option>
              @for (product of availableProducts; track product.id) {
                <option [value]="product.id">{{ product.name }} (SKU: {{ product.sku }}) - Stock: {{ product.stockLevel }}</option>
              }
            </select>
          </div>
          <div class="form-group">
            <label>Transaction Type *</label>
            <select [(ngModel)]="createForm.type">
              <option value="purchase">Purchase (Stock In)</option>
              <option value="sale">Sale (Stock Out)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Quantity *</label>
            <input type="number" [(ngModel)]="createForm.quantity" placeholder="Enter quantity" step="1" min="1" />
          </div>
          <div class="form-group">
            <label>Notes</label>
            <textarea [(ngModel)]="createForm.notes" placeholder="Optional notes" rows="3"></textarea>
          </div>
        }
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeCreateModal()">Cancel</button>
        @if (!productService.isLoading() && availableProducts.length > 0) {
          <button class="btn-save" (click)="createTransaction()">Create Transaction</button>
        }
      </div>
    </div>
  </div>
}

