<div class="layout">
  <app-sidebar
    [userName]="authService.currentUser()?.name || ''"
    [isAdmin]="authService.isAdmin()"
  />

  <div class="user-management-container">
    <header class="header">
      <div class="header-content">
        <h1>User Management</h1>
        <div class="header-actions">
          <span class="user-info">{{ authService.currentUser()?.name }}</span>
          <button class="btn-secondary" (click)="navigateToWelcome()">Back to Dashboard</button>
          <button class="btn-logout" (click)="authService.logout()">Logout</button>
        </div>
      </div>
    </header>

    <main class="main-content">
    @if (error()) {
      <div class="alert alert-error">{{ error() }}</div>
    }

    @if (success()) {
      <div class="alert alert-success">{{ success() }}</div>
    }

    <div class="toolbar">
      <div class="search-box">
        <input
          type="text"
          placeholder="Search users by name or email..."
          [(ngModel)]="searchTerm"
          class="search-input"
        />
        <span class="search-icon">üîç</span>
      </div>
      <div class="toolbar-right">
        <div class="user-count">
          Total Users: {{ users().length }}
        </div>
        <button class="btn-create" (click)="startCreate()" [disabled]="isCreating() || editingUser()">
          + Create User
        </button>
      </div>
    </div>

    @if (isCreating()) {
      <section class="add-employee-card">
        <div class="card-title">
          <div class="title-icon">üë§+</div>
          <div>
            <h3>Add New Employee</h3>
            <p>Fill in the details to create a new employee account</p>
          </div>
        </div>

        <div class="employee-form">
          <div class="form-grid">
            <div class="form-field">
              <label>Username *</label>
              <div class="input-with-icon">
                <span class="input-icon">üë§</span>
                <input type="text" [(ngModel)]="editForm.name" placeholder="e.g. johndoe" />
              </div>
              <span class="help-text">Used for login, no spaces</span>
            </div>
            <div class="form-field">
              <label>Full Name *</label>
              <div class="input-with-icon">
                <span class="input-icon">ü™™</span>
                <input type="text" [(ngModel)]="editForm.fullName" placeholder="e.g. John Doe" />
              </div>
            </div>
            <div class="form-field">
              <label>Email Address *</label>
              <div class="input-with-icon">
                <span class="input-icon">‚úâÔ∏è</span>
                <input type="email" [(ngModel)]="editForm.email" placeholder="e.g. john@company.com" />
              </div>
            </div>
            <div class="form-field">
              <label>Phone Number</label>
              <div class="input-with-icon">
                <span class="input-icon">üìû</span>
                <input type="tel" [(ngModel)]="editForm.phone" placeholder="e.g. +1 (555) 123-4567" />
              </div>
            </div>
          </div>

          <div class="info-grid">
            <div class="info-card info-warning">
              <div class="info-title">Password Information</div>
              <p>
                A temporary password will be automatically generated for the new employee.
                The password will be: <strong>first 4 letters of username + "123"</strong>.
              </p>
            </div>
            <div class="info-card info-access">
              <div class="info-title">Access Information</div>
              <ul>
                <li>View products and stock levels</li>
                <li>Update stock quantities</li>
                <li>Create sales transactions</li>
                <li>Generate basic reports</li>
              </ul>
            </div>
          </div>

          <div class="form-actions">
            <button class="btn-cancel" (click)="cancelEdit()">Cancel</button>
            <button class="btn-save" (click)="saveUser()">Create Employee Account</button>
          </div>
        </div>
      </section>
    }

      <div class="users-table-container">
        <table class="users-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Access Type</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @if (filteredUsers.length === 0) {
              <tr>
                <td colspan="5" class="no-data">
                  <div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
                    <span style="font-size: 48px;">üë•</span>
                    <div>
                      <p style="margin: 0 0 8px 0; font-weight: 600;">No users found</p>
                      @if (searchTerm()) {
                        <p style="margin: 0; color: #a0aec0; font-size: 14px;">Try adjusting your search</p>
                      } @else {
                        <p style="margin: 0; color: #a0aec0; font-size: 14px;">Create your first user to get started</p>
                      }
                    </div>
                  </div>
                </td>
              </tr>
            } @else {
              @for (user of filteredUsers; track user.id) {
                <tr>
                  @if (editingUser()?.id === user.id) {
                    <td>{{ user.id }}</td>
                    <td>
                      <input
                        type="text"
                        [(ngModel)]="editForm.name"
                        class="edit-input"
                      />
                    </td>
                    <td>
                      <input
                        type="email"
                        [(ngModel)]="editForm.email"
                        class="edit-input"
                      />
                    </td>
                    <td>
                      <select [(ngModel)]="editForm.role" class="edit-select">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                      </select>
                    </td>
                    <td>
                      <div class="edit-password-field">
                        <input
                          type="password"
                          [(ngModel)]="editForm.password"
                          placeholder="New password (optional)"
                          class="edit-input"
                        />
                      </div>
                      <div class="edit-actions">
                        <button class="btn-save" (click)="saveUser()">Save</button>
                        <button class="btn-cancel" (click)="cancelEdit()">Cancel</button>
                      </div>
                    </td>
                  } @else {
                    <td>{{ user.id }}</td>
                    <td>{{ user.name }}</td>
                    <td>{{ user.email }}</td>
                    <td>
                      <span [class]="'badge ' + getRoleBadgeClass(user.role)">
                        {{ user.role | uppercase }}
                      </span>
                    </td>
                    <td>
                      <button class="btn-edit" (click)="startEdit(user)">Edit</button>
                      @if (authService.currentUser()?.id !== user.id) {
                        <button class="btn-delete" (click)="deleteUser(user.id)">Delete</button>
                      } @else {
                        <span class="current-user-label">Current User</span>
                      }
                    </td>
                  }
                </tr>
              }
            }
          </tbody>
        </table>
      </div>
    </main>
  </div>
</div>

